# DIS-QAQC

There are three programs: one for calculating magnification, one for calculating the DOF of the high magnification lens, and one for calculating the DOF of the low magnification lens.

In all three programs, there is a PLOT_SHOW_TIME, RUN_NUMBER and NUM_ITERATIONS. The program will run on a loop, taking NUM_ITERATIONS amount of pictures, and will display plots for PLOT_SHOW_TIME in between each image. Each image is saved with the RUN_NUMBER at the beginning, so it can be changed in between running the program so that old images are not overwritten. 

How the magnification program works: It takes an image of a set of lines, fits a sine curve to every row on the square, finds the frequency using the Fourier transform, and calculates magnification using the number of lines in the image, pixel size, number of pixels, and number of lines in real life. It will produce and save the original image, a cropped image if it is cropped, and a histogram with the magnification of every row as well as an average magnification.
Usage Notes:
In the magnification program, when using the low magnification lens, the image will need to be cropped. In the last cell, in acquire_and_display_images, in the while loop, mag_cropped = image_data should be commented out and mag_cropped = image_data[image_data.shape[1]//2 ...] should be in place. When using the high magnification lens, the line that crops should be taken out and #mag_cropped = image_data should be left in place. The code is currently set to crop images taken with the low magnification lens to 600x600. This can be changed at the top of the cell in CROP_WIDTH and CROP_HEIGHT. There is currently a crop_mag_automatic function, and image_data = crop_mag_automatic... has been commented out. This function can crop an image to include the entirety of the Ronchi ruling, but will not work if there is anything in front of the ruling, like clips to hold the square in place. BIN_SIZE refers to how many pixels are in each bin before calculating magnification, PIXEL_SIZE is a camera specification that varies from model to model, LINES_MM is the number of lines per mm on the ruling being imaged, and WIDTH and HEIGHT are the image dimensions. In the line ax2.hist(mag_data, bins = 10), also in the while loop of acquire_and_display_images, the number of bins has been set to 10. For a more detailed look at the magnification values, this can be set to n_bins, which is calculated during the magnification calculations.

Depth of Field 25mm: 
How it works: It takes images of a set of vertical stripes on a wedge placed at a 45 degree angle, crops the image to contain only the stripes, then calculates contrast ratios along each row and returns the region that is in focus. The program will save an original image, than a plot displaying the cropped region, then just the portion that is in focus, and a graph of the contrast ratios. The method contrast_ratios returns the depth of field in pixels, the image data of the in portion region, as well as the array of contrast ratios. The program will then print the depth of field in pixels and in millimeters.
Usage Notes: Very occasionally, the cropping algorithm will crop too many of the stripes out. Adjusting the num_peaks parameter in the line that says accumulator, angles, rho = hough_line_peaks(h, theta, d, num_peaks = 25) in the find_hough_lines function can help with this problem. Raising num_peaks should help get a wider crop. As an alternative to get_cropped_region, which is called in the loop, there is also a get_cropped_region_p function that uses a Canny filter and probabilistic Hough transform instead of a horizontal Sobel filter and standard Hough transform. The probabilistic version is much faster, but tends to crop too little and give back images that contain extra space on the sides. In order to calculate the DOF correctly, the magnification of the lens at the current working distance must be manually set at the beginning of the last cell in the MAGNIFICATION variable.

Depth of Field 8.5mm:
How it works: This program is still in progress and has varied results. It assumes that you take images of the Ronchi ruling, changing the working distance by some set amount in between every image. It will then crop the image specified by CROP_WIDTH and CROP_HEIGHT, calculate contrast ratio row by row, then find an average for that image. After the loop finishes, it will plot a graph with the average contrast ratio of every image and display the cutoff (currently set to 0.992 of the max). It will then print how many images taken were in focus.
Usage: The program is currently set with NUM_ITERATIONS = 29 and PLOT_SHOW_TIME = 15. This was used in order to take images at 7 mm closer and farther than the target working distance, with a change in 0.5mm in between every picture. 

Common Errors:
If the camera has been set to a hardware trigger, there will be a Spinnaker error when attempting to acquire images. This can be fixed by factory resetting the camera. There is a factory reset function, and a factory_reset(cam) line that can be uncommented in the last cell, in the run_single_camera function. It is located right above the call to acquire_and_display_images(cam, node map, nodemap_tldevice). After running factory reset, there will be an error reading from the camera because the program is running more code but the camera can be power cycled. Just comment out the factory reset and run the program normally, and it should work.
If there is not enough available memory to allocate buffers for streaming(Spinnaker error 1016), restarting the kernel should fix the issue. Clearing out RAM by quitting other programs may also help.
If a runtime error has occurred, the camera will not be properly de-initialized. Before running any more code, the camera needs to be power cycled (unplugged and plugged). Otherwise, there will be a Spinnaker error the next time you run code (Image cleanup required as images are locked in the queue. [-1004])
If the exposure is too high (usually in higher hundred thousand range), there will be a Spinnaker EventData error. 

25mm DOF Specific:
If the image is too dark, the program cannot crop properly - increase exposure
Decreasing image width from the maximum will also help the program crop properly, because the 25mm lens usually takes a picture that includes multiple sets of stripes.
If the program crops out too much, the num_peaks parameter in the find_hough_lines cell that is passed into hough_line can be adjusted. Increasing num_peaks should give a wider crop, and decreasing it should make it narrower. 
